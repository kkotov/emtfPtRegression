---
title       : "EMTF $p_T$ Regression"
subtitle    :
author      : Khristian Kotov
job         :
framework   : io2012        # {io2012, html5slides, shower, dzslides, ...}
highlighter : highlight.js  # {highlight.js, prettify, highlight}
hitheme     : tomorrow      #
github:
  user: kkotov
  repo: emtfPtRegression
widgets     : [mathjax]     # {mathjax, quiz, bootstrap}
mode        : selfcontained # {standalone, draft}
---

## Outline

--- &twocol

## Properties of the measured rate

```{r message = F, echo = F}
mode_inv <- 15
mode = c(0, 0, 12, 0, 10, 5, 14, 0, 9, 5, 13, 3, 11, 7, 15)
df <- read.csv(file="../../pt/SingleMu_Pt1To1000_FlatRandomOneOverPt.csv",header=T,sep=',')
d1 <- df[df[,"mode.0."]==mode[mode_inv], c( grep("\\.[0-1]\\.",colnames(df),invert=T) , grep(".0.",colnames(df),fixed=T) ) ]
d2 <- df[df[,"mode.1."]==mode[mode_inv], c( grep("\\.[0-1]\\.",colnames(df),invert=T) , grep(".1.",colnames(df),fixed=T) ) ]
colnames(d1) <- sub(".0.", "", colnames(d1),fixed=T)
colnames(d2) <- sub(".1.", "", colnames(d2),fixed=T)
d <- rbind(d1,d2)

require(ranger)
vars <- with(d,data.frame( 1/muPtGen,
                           2*atan(exp(-muEtaGen)),
                           pt,
                           mypt,
                           dPhi12,
                           dPhi13,
                           dPhi14,
                           dPhi23,
                           dPhi24,
                           dPhi34,
                           dTheta12,
                           dTheta13,
                           dTheta14,
                           dTheta23,
                           dTheta24,
                           dTheta34,
                           factor(clct1,levels=c(2,3,4,5,6,7,8,9,10)),
                           factor(clct2,levels=c(2,3,4,5,6,7,8,9,10)),
                           factor(clct3,levels=c(2,3,4,5,6,7,8,9,10)),
                           factor(clct4,levels=c(2,3,4,5,6,7,8,9,10)),
                           factor(fr1,levels=c(0,1)),
                           factor(fr2,levels=c(0,1)),
                           factor(fr3,levels=c(0,1)),
                           factor(fr4,levels=c(0,1))
                           )
            )
predictors <- c("dPhi12", "dPhi13", "dPhi14", "dPhi23", "dPhi24", "dPhi34", "dTheta12", "dTheta13", "dTheta14", "dTheta23", "dTheta24", "dTheta34", "clct1", "clct2", "clct3", "clct4", "fr1", "fr2", "fr3", "fr4")
colnames(vars) <- c("muPtGenInv", "theta", "ptTrg", "mypt", predictors )
predictors <- c("theta", predictors)

set.seed(1)

part <- sample(seq(nrow(vars)), as.integer(nrow(vars)*0.75), replace=F)
trainSet <- vars[part,]
testSet <- vars[-part,]
POI <- which(colnames(vars)=="muPtGenInv")

f <- as.formula(paste("muPtGenInv ~ ", paste(predictors, collapse= "+")))

invisible( capture.output( modelFit <- ranger(f, data=trainSet, importance="impurity") ) )


source("../metrics.R")
binning <- seq(0,100,2)
nBins   <- length(binning)
slimDF  <- with(d, data.frame(true_pT = muPtGen, response_pT = pt) )
slimDF$trueBin <- sapply(slimDF$true_pT, findBin, binning)
pSpec   <- aggregate(slimDF, by=list(bin=slimDF$trueBin), function(x) x )
norms   <- sapply(pSpec$response_pT,length)
counts  <- t(sapply(pSpec$response_pT,function(x) sapply(binning,function(y) sum(unlist(x)>y) )))
turnOn  <- counts/norms

# Data below are generated from Andrew's /store/user/abrinke1/EMTF/Emulator/ntuples/ZeroBiasIsolatedBunch{0,1,2,3}
#  root ntuples translated into csv format with https://github.com/kkotov/emtfPtRegression/blob/master/root2csv.C
#  converter (check the heading comments inside for the use example)
# The cvs files were further skimmed with a bash batch job:
#  i=28; while [ $i -gt 0 ] ; do echo $i;  cat dump2.R | sed -e "s|PART|$i|g" > d$i"".R ; R CMD BATCH d$i.R ; rm -f .RData d$i.R d$i.Rout ; i=`expr $i - 1`; done
#  utilizing the https://github.com/kkotov/emtfPtRegression/blob/master/dump2.R script

for(f in paste("../../pt/s",c(0,1,2,3),".RData",sep='')) load(f)
zb <- s0
zb <- rbind(zb,s1)
zb <- rbind(zb,s2)
zb <- rbind(zb,s3)

ptMes <- zb$ptEMTF

require(ggplot2)
```

*** =left

```{r, fig.height=5., fig.width=5., fig.align = 'center', comment = NA, message = F, echo = F}
pp <- preprocess(modelFit,
                 testSet,
                 rateShape = data.frame( true_pT=seq(1.5,1000.5,1), trigRate=1/seq(1,1000,1)^3 ),
                 binning=seq(2,80,1)
                )

#tt <- rocMetric(pp)
#tt

tt <- turnOns(pp)
suppressWarnings( tt[["30"]] )
```

*** =right

```{r, fig.height=5., fig.width=5., fig.align = 'center', comment = NA, message = F, echo = F}

testSetZB <- with(zb, data.frame(theta = theta,
                                 dPhi12 = phi1-phi2,
                                 dPhi13 = phi1-phi3,
                                 dPhi14 = phi1-phi4,
                                 dPhi23 = phi2-phi4,
                                 dPhi24 = phi2-phi4,
                                 dPhi34 = phi3-phi4,
                                 dTheta12 = theta1-theta2,
                                 dTheta13 = theta1-theta3,
                                 dTheta14 = theta1-theta4,
                                 dTheta23 = theta2-theta3,
                                 dTheta24 = theta2-theta4,
                                 dTheta34 = theta3-theta4,
                                 clct1 = factor(clct1,levels=c(2,3,4,5,6,7,8,9,10)),
                                 clct2 = factor(clct2,levels=c(2,3,4,5,6,7,8,9,10)),
                                 clct3 = factor(clct3,levels=c(2,3,4,5,6,7,8,9,10)),
                                 clct4 = factor(clct4,levels=c(2,3,4,5,6,7,8,9,10)),
                                 fr1 = factor(fr1,levels=c(0,1)),
                                 fr2 = factor(fr2,levels=c(0,1)),
                                 fr3 = factor(fr3,levels=c(0,1)),
                                 fr4 = factor(fr4,levels=c(0,1))
                                )
                 )

pp2 <- preprocess(modelFit,
                 testSetZB,
                 rateShape = data.frame( true_pT=seq(1.5,1000.5,1), trigRate=1/seq(1,1000,1)^3 ),
                 binning=seq(2,80,1)
                )

tt2 <- rocMetric(pp2)
tt2
```

*** =fullwidth

Clearly seen are two components meeting at $\sim$100 GeV/$c$ (and the EMTF pT saturation)

Since all of the thresholds of interest are < 100 GeV/$c$ let's zoom in to the first component

--- .class #id

## Summary

* The underlying true rate spectrum consists of multiple components

* $p_T \sim$ [0-5] GeV/$c$ seems to be falling exponentially, but being suppressed by
the turn-on cannot be reliably measured from data

* $p_T \sim$ [5-80] GeV/$c$ seems to be described well by $1/p_T^3$ spectrum

* $p_T >$ 80 GeV/$c$ falls even faster, but presents a little interest

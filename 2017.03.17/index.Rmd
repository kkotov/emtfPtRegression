---
title       : "EMTF $p_T$ Regression"
subtitle    :
author      : Khristian Kotov
job         :
framework   : io2012        # {io2012, html5slides, shower, dzslides, ...}
highlighter : highlight.js  # {highlight.js, prettify, highlight}
hitheme     : tomorrow      #
github:
  user: kkotov
  repo: emtfPtRegression
widgets     : [mathjax]     # {mathjax, quiz, bootstrap}
mode        : selfcontained # {standalone, draft}
---

## Outline

Metrics
* ROC curves
* Efficiency-rate curves

Scaling baseline EMTF model for proper comparison

Input compression
* several test schemes
* overal performance
* sources of impact on efficiency 

Summary

--- &twocol

## Constructing ROC curves

[ROC curves](https://kkotov.github.io/emtfPtRegression/2017.02.10/#6) built with
[$1/p_T ^3$ spectrum](https://kkotov.github.io/emtfPtRegression/2017.03.03/#6)$^*$
and turn-ons for "myModel"$^{**}$ and EMTF ("baseline"):

```{r message = F, echo = F}
mode_inv <- 15
mode = c(0, 0, 12, 0, 10, 5, 14, 0, 9, 5, 13, 3, 11, 7, 15)
df <- read.csv(file="../../pt/SingleMu_Pt1To1000_FlatRandomOneOverPt_plusRPC.csv",header=T,sep=',')
d1 <- df[df[,"mode.0."]==mode[mode_inv], c( grep("\\.[0-1]\\.",colnames(df),invert=T) , grep(".0.",colnames(df),fixed=T) ) ]
d2 <- df[df[,"mode.1."]==mode[mode_inv], c( grep("\\.[0-1]\\.",colnames(df),invert=T) , grep(".1.",colnames(df),fixed=T) ) ]
colnames(d1) <- sub(".0.", "", colnames(d1),fixed=T)
colnames(d2) <- sub(".1.", "", colnames(d2),fixed=T)
d <- rbind(d1,d2)

require(ranger)

# Turn theta to integer and put it on the emulator's scale as it is done in (but in opposite direction):
# https://github.com/jiafulow/L1TriggerSep2016/blob/master/L1TMuonEndCap/src/PtAssignmentEngineAux.cc#L352-L353

vars <- with(d,data.frame( 1/muPtGen,
                           ( ifelse( 2*atan(exp(-muEtaGen))<3.1415927/2,
                                     2*atan(exp(-muEtaGen)),
                                     3.1415927-2*atan(exp(-muEtaGen))
                             ) * 180/3.1415927 - 8.5
                           ) * 128 / (45.0-8.5),
                           factor(ring1,levels=c(1,2,4)),
                           pt,
                           mypt,
                           dPhi12,
                           dPhi13,
                           dPhi14,
                           dPhi23,
                           dPhi24,
                           dPhi34,
                           dTheta12,
                           dTheta13,
                           dTheta14,
                           dTheta23,
                           dTheta24,
                           dTheta34,
                           factor(clct1,levels=c(2,3,4,5,6,7,8,9,10)),
                           factor(clct2,levels=c(2,3,4,5,6,7,8,9,10)),
                           factor(clct3,levels=c(2,3,4,5,6,7,8,9,10)),
                           factor(clct4,levels=c(2,3,4,5,6,7,8,9,10)),
                           factor(fr1,levels=c(0,1)),
                           factor(fr2,levels=c(0,1)),
                           factor(fr3,levels=c(0,1)),
                           factor(fr4,levels=c(0,1))
                           )
            )
predictors <- c("dPhi12", "dPhi13", "dPhi14", "dPhi23", "dPhi24", "dPhi34", "dTheta12", "dTheta13", "dTheta14", "dTheta23", "dTheta24", "dTheta34", "clct1", "clct2", "clct3", "clct4", "fr1", "fr2", "fr3", "fr4")
colnames(vars) <- c("muPtGenInv", "theta", "ring1", "ptTrg", "mypt", predictors )
predictors <- c("theta", "ring1", predictors)

vars$zero <- 0
vars$one  <- 1

set.seed(1)

part <- sample(seq(nrow(vars)), as.integer(nrow(vars)*0.75), replace=F)
trainSet <- vars[part,]
testSet <- vars[-part,]
POI <- which(colnames(vars)=="muPtGenInv")

f <- as.formula(paste("muPtGenInv ~ ", paste(predictors, collapse= "+")))

invisible( capture.output( modelFit <- ranger(f, data=trainSet, importance="impurity") ) )


# Data below are generated from Andrew's /store/user/abrinke1/EMTF/Emulator/ntuples/ZeroBiasIsolatedBunch{0,1,2,3}
#  root ntuples translated into csv format with https://github.com/kkotov/emtfPtRegression/blob/master/root2csv.C
#  converter (check the heading comments inside for the use example)
# The cvs files were further skimmed with a bash batch job:
#  i=28; while [ $i -gt 0 ] ; do echo $i;  cat dump2.R | sed -e "s|PART|$i|g" > d$i"".R ; R CMD BATCH d$i.R ; rm -f .RData d$i.R d$i.Rout ; i=`expr $i - 1`; done
#  utilizing the https://github.com/kkotov/emtfPtRegression/blob/master/dump2.R script

for(f in paste("../../pt/s",c(0,1,2,3),"_rpc.RData",sep='')) load(f)
zb <- s0
zb <- rbind(zb,s1)
zb <- rbind(zb,s2)
zb <- rbind(zb,s3)

testSetZB <- with(subset(zb,mode==15), data.frame(
                                 ptRef = ptEMTF,
                                 ring1 = factor(ring1,levels=c(1,2,4)),
                                 theta = theta_i,
                                 dPhi12 = phi1-phi2,
                                 dPhi13 = phi1-phi3,
                                 dPhi14 = phi1-phi4,
                                 dPhi23 = phi2-phi4,
                                 dPhi24 = phi2-phi4,
                                 dPhi34 = phi3-phi4,
                                 dTheta12 = theta1-theta2,
                                 dTheta13 = theta1-theta3,
                                 dTheta14 = theta1-theta4,
                                 dTheta23 = theta2-theta3,
                                 dTheta24 = theta2-theta4,
                                 dTheta34 = theta3-theta4,
                                 clct1 = factor(clct1,levels=c(2,3,4,5,6,7,8,9,10)),
                                 clct2 = factor(clct2,levels=c(2,3,4,5,6,7,8,9,10)),
                                 clct3 = factor(clct3,levels=c(2,3,4,5,6,7,8,9,10)),
                                 clct4 = factor(clct4,levels=c(2,3,4,5,6,7,8,9,10)),
                                 fr1 = factor(fr1,levels=c(0,1)),
                                 fr2 = factor(fr2,levels=c(0,1)),
                                 fr3 = factor(fr3,levels=c(0,1)),
                                 fr4 = factor(fr4,levels=c(0,1))
                                )
                 )

tszb <- testSetZB[-which(is.na(testSetZB$clct1) | is.na(testSetZB$clct2) | is.na(testSetZB$clct3) | is.na(testSetZB$clct4) ),]

tszb$zero <- 0
tszb$one  <- 1

invisible( capture.output( tszb$res <- 1/predict(modelFit,tszb)$predictions ) )

```

```{r message = F, echo = F}

require(ggplot2)
require("gridExtra")

source("../metrics.R")

## Unless I clean the environment of preprocess function, the code below may crash complaining:
##  "Error in lazyLoadDBinsertValue(data, datafile, ascii, compress, envhook)"
pp <- preprocess(modelFit,
                 testSet,
##                 rateShape = data.frame( true_pT = seq(1.01,1000.01,0.5), trigRate = 1/seq(1,1000,0.5)^3 ),
                 rateShapeBinned = c(1,1/seq(2,200,0.5)^3), # don't forget the underflow
                 binning = seq(2,200,0.5)
                )

myTurnOn        <- pp$getMyTurnOn()
refTurnOn       <- pp$getRefTurnOn()
binning         <- pp$getBinning()
rateShapeBinned <- pp$getRateShapeBinned()
nBins           <- length(binning)

```

*** =left

```{r, fig.height=4., fig.width=4., fig.align = 'center', comment = NA, message = F, echo = F, dev='svg'}

source("../metrics.R")

tt <- turnOns(rateShapeBinned = rateShapeBinned,
              myModelTurnOn = myTurnOn,
              referenceTurnOn = refTurnOn,
              binning = binning,
              refScale = 1.43
      )

suppressWarnings( invisible( capture.output( 
    grid.arrange(tt[["20"]] + theme(legend.position="none"),
                 tt[["40"]] + theme(legend.position="none"),
                 tt[["60"]] + theme(legend.position="none"),
                 tt[["80"]] + theme(legend.position="none")
                )
) ) )

```

*** =right

```{r, fig.height=4., fig.width=4., fig.align = 'center', comment = NA, message = F, echo = F, dev='svg'}

roc <- rocMetric(rateShapeBinned = rateShapeBinned,
                 myModelTurnOn = myTurnOn,
                 referenceTurnOn = refTurnOn,
                 binning = binning,
                 refScale = 1.43
       )

truePosPlot <- ggplot(data.frame(pT = c( binning, binning ),
                                 eff = c( roc[["myEff"]], roc[["refEff"]] ),
                                 model = factor( c(rep("myModel",nBins), rep("baseline",nBins) ) )
                      ),
                      aes(x = pT, y = eff, type = model, color = model)
                 ) +
                 geom_point(shape = 1, size = 0.1) +
                 theme(
                       title = element_text(size=15),
                       axis.title.x = element_text(size=15),
                       axis.text.x  = element_text(size=15)
                 ) +
                 labs(x = expression(paste(p[T] ^{true}," (GeV/c)")),
                      y = "true positive"
                 )

falsePosPlot <- ggplot(data.frame(pT = c( binning, binning ),
                                  eff = c( roc[["myFake"]], roc[["refFake"]] ),
                                  model = factor( c(rep("myModel",nBins), rep("baseline",nBins) ) )
                       ),
                       aes(x = pT, y = eff, type = model, color = model)
                ) +
                geom_point(shape = 1, size = 0.1) +
                theme(
                      title = element_text(size=15),
                      axis.title.x = element_text(size=15),
                      axis.text.x  = element_text(size=15)
                ) +
                labs(x = expression(paste(p[T] ^{true}," (GeV/c)")),
                     y = "false positive"
                ) +
                scale_y_log10()

suppressWarnings( invisible( capture.output( 
    grid.arrange(
                 arrangeGrob(truePosPlot  + xlim(0, 100) + theme(legend.position="none"),
                             falsePosPlot + xlim(0, 100) + theme(legend.position="none"),
                             ncol=2
                 ),
                 roc[["rocPlot"]] + labs(title=""), # + xlim(0.75, 1),
                 nrow = 2
    )
) ) )

```

*** =fullwidth

$^*$&nbsp;any&nbsp;shape do well for qualitative comparison of the two models (i.e. relative behavior)

$^{**}$ "myModel" is trained with $\Delta\phi \times 6$, $\Delta\theta \times 6$, $CLCT \times 4$, $FR \times 4$ (all full precision)

--- .class #id

## Constructing efficiency-rate metric

Like for ROCs, efficiency results from convolution of spectrum with turn-on above threshold

Fraction of fakes is replaced with absolute number of events with predicted pT &gt; threshold

Comparing baseline and "myModel" using Andrew's zero bias ntuples:

```{r, fig.height=4., fig.width=8., fig.align = 'center', comment = NA, message = F, echo = F, dev='svg'}

nBins   <- length(binning)
myRate  <- sapply(binning, function(x) sum(tszb$res>x) )
refRate <- sapply(binning, function(x) sum(tszb$ptRef>x) )

# See http://stackoverflow.com/questions/8197559/emulate-ggplot2-default-color-palette for the choise of colours
effRatePlot <- ggplot(data.frame(binning[1:100],
                                 eff = c(roc$myEff[1:100], roc$refEff[1:100]),
                                 rate = c(myRate[1:100], refRate[1:100]),
                                 model = c(rep("myModel",100), rep("baseline",100)) 
                                ),
                      aes(x = rate, y = eff, group = model, colour = model)
               ) +
               geom_point(shape=1,size=0.1) + 
               geom_line() + 
               theme(
                    title = element_text(size=15),
                    axis.title.x = element_text(size=15),
                    axis.text.x  = element_text(size=15),
                    legend.position = c(.20, .70),
                    legend.background = element_rect(fill = 'grey92', colour = 'black', size=0),
                    legend.text = element_text(size=rel(1.2)),
                    legend.title = element_text(size=rel(0.8), face="bold", hjust=0)
               ) +
               labs(y = "efficiency",
                    x = "rate",
                    title = "Efficiency-rate curve"
               ) +
               scale_colour_manual(values = c("myModel" = "#F8766D", "baseline" = "#00BFC4"),
                                   breaks = c("myModel", "baseline"),
                                   labels = c("myModel", "baseline")
               ) +
               scale_x_log10()

suppressWarnings( invisible( capture.output(
  effRatePlot #+ xlim(0.75, 1) # + scale_y_log10()
) ) )

```

--- &twocol

## Scaling baseline turn-ons

Baseline model was originally scaled to have ~90% efficiency at any given threshold

<!--Rescaling causes a small horizontal and large vertical shifts ([consequence of falling rate](https://kkotov.github.io/emtfPtRegression/2017.02.10/#6)):-->

Comparing baseline to itself for different scales shows apples-to-oranges problem:

*** =left

```{r, fig.height=4., fig.width=4., fig.align = 'center', comment = NA, message = F, echo = F, dev='svg'}

roc1.1 <- rocMetric(rateShapeBinned = rateShapeBinned,
                    myModelTurnOn = myTurnOn,
                    referenceTurnOn = refTurnOn,
                    binning = binning,
                    refScale = 1.1
          )

roc1.2 <- rocMetric(rateShapeBinned = rateShapeBinned,
                    myModelTurnOn = myTurnOn,
                    referenceTurnOn = refTurnOn,
                    binning = binning,
                    refScale = 1.2
          )

roc1.3 <- rocMetric(rateShapeBinned = rateShapeBinned,
                    myModelTurnOn = myTurnOn,
                    referenceTurnOn = refTurnOn,
                    binning = binning,
                    refScale = 1.3
          )

roc1.4 <- rocMetric(rateShapeBinned = rateShapeBinned,
                    myModelTurnOn = myTurnOn,
                    referenceTurnOn = refTurnOn,
                    binning = binning,
                    refScale = 1.4
          )

roc1.5 <- rocMetric(rateShapeBinned = rateShapeBinned,
                    myModelTurnOn = myTurnOn,
                    referenceTurnOn = refTurnOn,
                    binning = binning,
                    refScale = 1.5
          )

roc1.6 <- rocMetric(rateShapeBinned = rateShapeBinned,
                    myModelTurnOn = myTurnOn,
                    referenceTurnOn = refTurnOn,
                    binning = binning,
                    refScale = 1.6
          )

roc1.7 <- rocMetric(rateShapeBinned = rateShapeBinned,
                    myModelTurnOn = myTurnOn,
                    referenceTurnOn = refTurnOn,
                    binning = binning,
                    refScale = 1.7
          )

refROCdf <- data.frame( truePos  = roc1.1[["refEff"]],
                        falsePos = roc1.1[["refFake"]],
                        scale    = rep("1.1",nBins)
            )
refROCdf <- rbind( data.frame( truePos  = roc1.2[["refEff"]],
                               falsePos = roc1.2[["refFake"]],
                               scale    = rep("1.2",nBins)
                   ),
                   refROCdf
            )
refROCdf <- rbind( data.frame( truePos  = roc1.3[["refEff"]],
                               falsePos = roc1.3[["refFake"]],
                               scale    = rep("1.3",nBins)
                   ),
                   refROCdf
            )
refROCdf <- rbind( data.frame( truePos  = roc1.4[["refEff"]],
                               falsePos = roc1.4[["refFake"]],
                               scale    = rep("1.4",nBins)
                   ),
                   refROCdf
            )
refROCdf <- rbind( data.frame( truePos  = roc1.5[["refEff"]],
                               falsePos = roc1.5[["refFake"]],
                               scale    = rep("1.5",nBins)
                   ),
                   refROCdf
            )
refROCdf <- rbind( data.frame( truePos  = roc1.6[["refEff"]],
                               falsePos = roc1.6[["refFake"]],
                               scale    = rep("1.6",nBins)
                   ),
                   refROCdf
            )
refROCdf <- rbind( data.frame( truePos  = roc1.7[["refEff"]],
                               falsePos = roc1.7[["refFake"]],
                               scale    = rep("1.7",nBins)
                   ),
                   refROCdf
            )

refROCdf$scale <- factor(refROCdf$scale)

rocScaledPlot <- ggplot(refROCdf, aes(y = truePos, x = falsePos, group = scale, colour = scale)) +
        geom_line() +
        geom_point(shape=1,size=0.1) +
        theme(
            title = element_text(size=15),
            axis.title.x = element_text(size=15),
            axis.text.x  = element_text(size=15),
            legend.position = c(.70, .40),
            legend.background = element_rect(fill = 'grey92', colour = 'black', size=0),
            legend.text=element_text(size=rel(1.2)),
            legend.title=element_text(size=rel(0.8), face="bold", hjust=0)
        ) +
        labs( y="true positive (efficiency)",
              x="false positive (fakes' fraction)",
              title="ROC curves"
        ) +
        scale_x_log10() #+
#        xlim(0.5,0.97)

suppressWarnings( invisible( capture.output( 
    rocScaledPlot
) ) )

```

*** =right

```{r, fig.height=4., fig.width=4., fig.align = 'center', comment = NA, message = F, echo = F, dev='svg'}

refEffRateDF <- data.frame( eff   = roc1.1[["refEff"]],
                            rate  = refRate,
                            scale = rep("1.1",nBins)
                )
refEffRateDF <- rbind( data.frame( eff   = roc1.2[["refEff"]],
                                   rate  = refRate,
                                   scale = rep("1.2",nBins)
                       ),
                   refEffRateDF
                )
refEffRateDF <- rbind( data.frame( eff   = roc1.3[["refEff"]],
                                   rate  = refRate,
                                   scale = rep("1.3",nBins)
                       ),
                   refEffRateDF
                )
refEffRateDF <- rbind( data.frame( eff   = roc1.4[["refEff"]],
                                   rate  = refRate,
                                   scale = rep("1.4",nBins)
                       ),
                   refEffRateDF
                )
refEffRateDF <- rbind( data.frame( eff   = roc1.5[["refEff"]],
                                   rate  = refRate,
                                   scale = rep("1.5",nBins)
                       ),
                   refEffRateDF
                )
refEffRateDF <- rbind( data.frame( eff   = roc1.6[["refEff"]],
                                   rate  = refRate,
                                   scale = rep("1.6",nBins)
                       ),
                   refEffRateDF
                )
refEffRateDF <- rbind( data.frame( eff   = roc1.7[["refEff"]],
                                   rate  = refRate,
                                   scale = rep("1.7",nBins)
                       ),
                   refEffRateDF
                )

effRateScaledPlot <- ggplot(refEffRateDF, aes(x = rate, y = eff, group = scale, colour = scale) ) +
               geom_point(shape=1,size=0.1) + 
               geom_line() + 
               theme(
                    title = element_text(size=15),
                    axis.title.x = element_text(size=15),
                    axis.text.x  = element_text(size=15),
                    legend.position = c(.70, .40),
                    legend.background = element_rect(fill = 'grey92', colour = 'black', size=0),
                    legend.text = element_text(size=rel(1.2)),
                    legend.title = element_text(size=rel(0.8), face="bold", hjust=0)
               ) +
               labs(y = "efficiency",
                    x = "total rate",
                    title = "Efficiency-rate curve"
               ) +
               scale_x_log10()

suppressWarnings( invisible( capture.output(
  effRateScaledPlot #+ xlim(0.5, 1) # + scale_y_log10()
) ) )

```

*** =fullwidth

Baseline put on "myModel" scale (turn-ons cross at 50%) by multiplying thresholds with $1.43$


--- .class #id

## Relative importance of the inputs

```{r, fig.height=4., fig.width=8., fig.align = 'center', comment = NA, message = F, echo = F, dev='svg'}

#barplot( modelFit1$variable.importance[1:18], horiz=T, col='red', xlab='Delta MSE', las=2, main='Scheme #1' )

barPlot <- ggplot( data.frame( importance = modelFit$variable.importance,
                               name       = names(modelFit$variable.importance)
                   ), aes(x=reorder(name,c(13,14,1:12,15:22)), y=importance)
                 ) +
                 geom_bar(stat="identity", col="red", fill="red") +
                 coord_flip() +
                 theme(
                     title = element_text(size=15),
                     axis.title.x = element_text(size=15),
                     axis.text.x  = element_text(size=15)
                 ) +
                 labs(x = "",
                     y = expression(paste("Importance (", Delta ,"MSE)",sep='')), 
                     title = "myModel"
                 )

barPlot

```

The most important predictors are $\Delta\phi$ followed by $clct1$ (!), $\Delta\theta$, and $\theta + ring$

Compression (stipping most/least significant bits - MSB/LSB) should be guided by relative the importance of specific bits

--- .class #id

## Input compression

As proposed [earlier](https://kkotov.github.io/emtfPtRegression/2017.01.19/#12), I perform input transformations:
* "unsign" predictors; keep a bit for relative sign (e.g. ($S^\phi_{12,23}$) $\equiv$ sign($\Delta\phi_{23}*\Delta\phi_{12}$))
* "saturate" predictors at $N$ least significant bits (e.g. $|\Delta\theta_{12}|_{2 LSBs}\in\{0,1,2,3\}$)
* calculate dependent predictors "on the fly" (e.g. $\Delta\phi_{14} = \Delta\phi_{12} + \Delta\phi_{23} + \Delta\phi_{34}$) 

Following schemes (inspired by
[Andrew's talk](https://indico.cern.ch/event/623713/contributions/2516606/subcontributions/222725/attachments/1429297/2194604/2017_03_09_EMTF_LUT_bit_assignment.pdf))
for number of bits for predictors are used:
 
type | $\theta$ | $\Delta\phi_{12}$ | $\Delta\phi_{23}$ | $\Delta\phi_{34}$ | $S^\phi_{12,23}$ | $S^\phi_{12,34}$ | $\Delta\theta_{12}$ | $\Delta\theta_{23}$ | $\Delta\theta_{34}$ | $\Delta\theta_{13}$ | $\Delta\theta_{14}$ | $\Delta\theta_{24}$ | clct | fr
-----|----------|-------------------|-------------------|-------------------|------------------|------------------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------------|---------------|-----------
#1   |  10      |      10           |        10         |         10        |         1        |        1         |         5           |         5            |         5          |         5           |       5             |           5         |  4,4,4,4 | 1,1,1,1 
#2   |  10      |     `7`           |       `5`         |        `5`        |         1        |        1         |         5           |         5            |         5          |         5           |       5             |           5         |  4,4,4,4 | 1,1,1,1 
#3   |  5       |      7            |        5          |         5         |         1        |        1         |         0           |         0            |        `0`         |         `0`         |         `3`         |          0          |  4,4,4,4 | 1,1,1,1 
#4   |  5       |      7            |        5          |         5         |         1        |        1         |         0           |         0            |         0          |          0          |          3          |          0          |  4,`0,0,0` | 1,`0,0,0` 
#5   |  5       |      7            |        5          |         5         |         1        |        1         |         0           |         0            |         0          |          0          |          3          |          0          |  `2`,0,0,0 | `0`,0,0,0 

(type #0 = "myModel" on previous slides, applies no compression; everything is mode=15 here)


--- &twocol

## Testing compression schemes

```{r message = F, echo = F}
# type #1

source("../utils.R")

vars1 <- with(vars,data.frame( muPtGenInv,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],10,0),
                           ptTrg,
                           abs(sat(dPhi12,10)),
                           abs(sat(dPhi23,10)),
                           abs(sat(dPhi34,10)),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           abs(sat(dPhi12,10)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,10)), # analogous to dPhi13
                           abs(sat(dPhi12,10)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,10)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,10)),
                           abs(sat(dPhi23,10)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,10)), # analogous to dPhi24
                           abs(sat(dTheta12,5)),
                           abs(sat(dTheta23,5)),
                           abs(sat(dTheta34,5)),
                           as.factor(ifelse(dTheta23*dTheta12>=0,zero,one)),
                           as.factor(ifelse(dTheta34*dTheta12>=0,zero,one)),
                           abs(sat(dTheta12,5)) + ifelse(dTheta23*dTheta12>=0,one,-one)*abs(sat(dTheta23,5)), # analogous to dTheta13
                           abs(sat(dTheta12,5)) + ifelse(dTheta23*dTheta12>=0,one,-one)*abs(sat(dTheta23,5)) + ifelse(dTheta34*dTheta12>=0,one,-one)*abs(sat(dTheta34,5)),
                           abs(sat(dTheta23,5)) + ifelse(dTheta34*dTheta12>=0,one,-one)*abs(sat(dTheta34,5)), # analogous to dTheta24
                           clct1,
                           clct2,
                           clct3,
                           clct4,
                           fr1,
                           fr2,
                           fr3,
                           fr4
                             )
         )

predictors1 <- c("dPhi12", "dPhi23", "dPhi34", "sPhi123", "sPhi134", "dPhi13", "dPhi14", "dPhi24", "dTheta12", "dTheta23", "dTheta34", "sTheta123", "sTheta134", "dTheta13", "dTheta14", "dTheta24", "clct1", "clct2", "clct3", "clct4", "fr1", "fr2", "fr3", "fr4")
colnames(vars1) <- c("muPtGenInv", "theta", "ptTrg", predictors1 )
predictors1 <- c("theta", predictors1)

set.seed(1)

trainSet1 <- vars1[part,]
testSet1 <- vars1[-part,]

f1 <- as.formula(paste("muPtGenInv ~ ", paste(predictors1, collapse= "+")))

invisible( capture.output( modelFit1 <- ranger(f1, data=trainSet1, importance="impurity") ) )
```


```{r message = F, echo = F}
# type #2

vars2 <- with(vars,data.frame( muPtGenInv,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],10,0),
                           ptTrg,
                           abs(sat(dPhi12,7)),
                           abs(sat(dPhi23,5)),
                           abs(sat(dPhi34,5)),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           abs(sat(dPhi12,7)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,5)), # analogous to dPhi13
                           abs(sat(dPhi12,7)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,5)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,5)),
                           abs(sat(dPhi23,5)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,5)), # analogous to dPhi24
                           abs(sat(dTheta12,5)),
                           abs(sat(dTheta23,5)),
                           abs(sat(dTheta34,5)),
                           as.factor(ifelse(dTheta23*dTheta12>=0,zero,one)),
                           as.factor(ifelse(dTheta34*dTheta12>=0,zero,one)),
                           abs(sat(dTheta12,5)) + ifelse(dTheta23*dTheta12>=0,one,-one)*abs(sat(dTheta23,5)), # analogous to dTheta13
                           abs(sat(dTheta12,5)) + ifelse(dTheta23*dTheta12>=0,one,-one)*abs(sat(dTheta23,5)) + ifelse(dTheta34*dTheta12>=0,one,-one)*abs(sat(dTheta34,5)),
                           abs(sat(dTheta23,5)) + ifelse(dTheta34*dTheta12>=0,one,-one)*abs(sat(dTheta34,5)), # analogous to dTheta24
                           clct1,
                           clct2,
                           clct3,
                           clct4,
                           fr1,
                           fr2,
                           fr3,
                           fr4
                             )
         )

predictors2 <- c("dPhi12", "dPhi23", "dPhi34", "sPhi123", "sPhi134", "dPhi13", "dPhi14", "dPhi24", "dTheta12", "dTheta23", "dTheta34", "sTheta123", "sTheta134", "dTheta13", "dTheta14", "dTheta24", "clct1", "clct2", "clct3", "clct4", "fr1", "fr2", "fr3", "fr4")
colnames(vars2) <- c("muPtGenInv", "theta", "ptTrg", predictors2 )
predictors2 <- c("theta", predictors2)

set.seed(1)

trainSet2 <- vars2[part,]
testSet2 <- vars2[-part,]

f2 <- as.formula(paste("muPtGenInv ~ ", paste(predictors2, collapse= "+")))

invisible( capture.output( modelFit2 <- ranger(f2, data=trainSet2, importance="impurity") ) )
```

```{r message = F, echo = F}
# type #3

vars3 <- with(vars,data.frame( muPtGenInv,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],7,2),
                           ptTrg,
                           abs(sat(dPhi12,7)),
                           abs(sat(dPhi23,5)),
                           abs(sat(dPhi34,5)),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           abs(sat(dPhi12,7)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,5)), # analogous to dPhi13
                           abs(sat(dPhi12,7)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,5)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,5)),
                           abs(sat(dPhi23,5)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,5)), # analogous to dPhi24
                           abs(sat(dTheta14,3)),
                           clct1,
                           clct2,
                           clct3,
                           clct4,
                           fr1,
                           fr2,
                           fr3,
                           fr4
                             )
         )

predictors3 <- c("dPhi12", "dPhi23", "dPhi34", "sPhi123", "sPhi134", "dPhi13", "dPhi14", "dPhi24", "dTheta14", "clct1", "clct2", "clct3", "clct4", "fr1", "fr2", "fr3", "fr4")
colnames(vars3) <- c("muPtGenInv", "theta", "ptTrg", predictors3 )
predictors3 <- c("theta", predictors3)

set.seed(1)

trainSet3 <- vars3[part,]
testSet3 <- vars3[-part,]

f3 <- as.formula(paste("muPtGenInv ~ ", paste(predictors3, collapse= "+")))

invisible( capture.output( modelFit3 <- ranger(f3, data=trainSet3, importance="impurity") ) )
```

```{r message = F, echo = F}
# type #4

vars4 <- with(vars,data.frame( muPtGenInv,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],7,2),
                           ptTrg,
                           abs(sat(dPhi12,7)),
                           abs(sat(dPhi23,5)),
                           abs(sat(dPhi34,5)),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           abs(sat(dPhi12,7)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,5)), # analogous to dPhi13
                           abs(sat(dPhi12,7)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,5)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,5)),
                           abs(sat(dPhi23,5)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,5)), # analogous to dPhi24
                           abs(sat(dTheta14,3)),
                           clct1,
                           fr1
                             )
         )

predictors4 <- c("dPhi12", "dPhi23", "dPhi34", "sPhi123", "sPhi134", "dPhi13", "dPhi14", "dPhi24", "dTheta14", "clct1", "fr1")
colnames(vars4) <- c("muPtGenInv", "theta", "ptTrg", predictors4 )
predictors4 <- c("theta", predictors4)

set.seed(1)

trainSet4 <- vars4[part,]
testSet4 <- vars4[-part,]

f4 <- as.formula(paste("muPtGenInv ~ ", paste(predictors4, collapse= "+")))

invisible( capture.output( modelFit4 <- ranger(f4, data=trainSet4, importance="impurity") ) )
```

```{r message = F, echo = F}
# type #5

vars5 <- with(vars,data.frame( muPtGenInv,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],7,2),
                           ptTrg,
                           abs(sat(dPhi12,7)),
                           abs(sat(dPhi23,5)),
                           abs(sat(dPhi34,5)),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           abs(sat(dPhi12,7)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,5)), # analogous to dPhi13
                           abs(sat(dPhi12,7)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,5)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,5)),
                           abs(sat(dPhi23,5)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,5)), # analogous to dPhi24
                           abs(sat(dTheta14,3)),
                           c(0,0,0,0,1,1,2,2,3,3,3,0,0,0,0,0)[bitwAnd(as.integer(as.character(clct1)),0xF)+1]
                             )
         )

predictors5 <- c("dPhi12", "dPhi23", "dPhi34", "sPhi123", "sPhi134", "dPhi13", "dPhi14", "dPhi24", "dTheta14", "clct1")
colnames(vars5) <- c("muPtGenInv", "theta", "ptTrg", predictors5 )
predictors5 <- c("theta", predictors5)

set.seed(1)

trainSet5 <- vars5[part,]
testSet5 <- vars5[-part,]

f5 <- as.formula(paste("muPtGenInv ~ ", paste(predictors5, collapse= "+")))

invisible( capture.output( modelFit5 <- ranger(f5, data=trainSet5, importance="impurity") ) )
```



*** =left

```{r message = F, echo = F}
invisible( capture.output(
pp1 <- preprocess( modelFit = modelFit1,
                   testSet = testSet1,
                   rateShapeBinned,
                   binning
       )
) )
myTurnOnComp1 <- pp1$getMyTurnOn()
rm(pp1)
```
```{r message = F, echo = F}
invisible( capture.output(
pp2 <- preprocess( modelFit = modelFit2,
                   testSet = testSet2,
                   rateShapeBinned,
                   binning
                 )
) )
myTurnOnComp2 <- pp2$getMyTurnOn()
rm(pp2)
```
```{r message = F, echo = F}
invisible( capture.output(
pp3 <- preprocess( modelFit = modelFit3,
                   testSet = testSet3,
                   rateShapeBinned,
                   binning
                 )
) )
myTurnOnComp3 <- pp3$getMyTurnOn()
rm(pp3)
```
```{r message = F, echo = F}
invisible( capture.output(
pp4 <- preprocess( modelFit = modelFit4,
                   testSet = testSet4,
                   rateShapeBinned,
                   binning
                 )
) )
myTurnOnComp4 <- pp4$getMyTurnOn()
rm(pp4)
```
```{r message = F, echo = F}
invisible( capture.output(
pp5 <- preprocess( modelFit = modelFit5,
                   testSet = testSet5,
                   rateShapeBinned,
                   binning
                 )
) )
myTurnOnComp5 <- pp5$getMyTurnOn()
rm(pp5)
```

```{r, fig.height=4., fig.width=4., fig.align = 'center', comment = NA, message = F, echo = F, dev='svg'}

roc1 <- rocMetric( rateShapeBinned = rateShapeBinned,
                   myModelTurnOn = myTurnOnComp1,
                   referenceTurnOn = myTurnOn,
                   binning = binning,
                   refScale = 1.0 # the reference here is no longer EMTF baseline!
        )
roc2 <- rocMetric( rateShapeBinned = rateShapeBinned,
                   myModelTurnOn = myTurnOnComp2,
                   referenceTurnOn = myTurnOn,
                   binning = binning,
                   refScale = 1.0 # the reference here is no longer EMTF baseline!
        )
roc3 <- rocMetric( rateShapeBinned = rateShapeBinned,
                   myModelTurnOn = myTurnOnComp3,
                   referenceTurnOn = myTurnOn,
                   binning = binning,
                   refScale = 1.0 # the reference here is no longer EMTF baseline!
        )
roc4 <- rocMetric( rateShapeBinned = rateShapeBinned,
                   myModelTurnOn = myTurnOnComp4,
                   referenceTurnOn = myTurnOn,
                   binning = binning,
                   refScale = 1.0 # the reference here is no longer EMTF baseline!
        )
roc5 <- rocMetric( rateShapeBinned = rateShapeBinned,
                   myModelTurnOn = myTurnOnComp5,
                   referenceTurnOn = myTurnOn,
                   binning = binning,
                   refScale = 1.0 # the reference here is no longer EMTF baseline!
        )

myModelROCdf <- data.frame( truePos  = roc1[["refEff"]],
                            falsePos = roc1[["refFake"]],
                            model    = rep("uncompressed",nBins)
                )
comp1ROCdf   <- data.frame( truePos  = roc1[["myEff"]],
                            falsePos = roc1[["myFake"]],
                            model    = rep("scheme #1",nBins)
                )
comp2ROCdf   <- data.frame( truePos  = roc2[["myEff"]],
                            falsePos = roc2[["myFake"]],
                            model    = rep("scheme #2",nBins)
                )
comp3ROCdf   <- data.frame( truePos  = roc3[["myEff"]],
                            falsePos = roc3[["myFake"]],
                            model    = rep("scheme #3",nBins)
                )
comp4ROCdf   <- data.frame( truePos  = roc4[["myEff"]],
                            falsePos = roc4[["myFake"]],
                            model    = rep("scheme #4",nBins)
                )
comp5ROCdf   <- data.frame( truePos  = roc5[["myEff"]],
                            falsePos = roc5[["myFake"]],
                            model    = rep("scheme #5",nBins)
                )

start <- sum(rateShapeBinned==0) + 1
myModelROCdf   <- myModelROCdf[start:nBins,]
comp1ROCdf     <- comp1ROCdf[start:nBins,]
comp2ROCdf     <- comp2ROCdf[start:nBins,]
comp3ROCdf     <- comp3ROCdf[start:nBins,]
comp4ROCdf     <- comp4ROCdf[start:nBins,]
comp5ROCdf     <- comp5ROCdf[start:nBins,]

compsDF <- rbind(myModelROCdf,comp1ROCdf)
compsDF <- rbind(compsDF,comp2ROCdf)
compsDF <- rbind(compsDF,comp3ROCdf)
compsDF <- rbind(compsDF,comp4ROCdf)
compsDF <- rbind(compsDF,comp5ROCdf)

compsDF$model <- factor(compsDF$model)

compsPlot <- ggplot(compsDF, aes(y = truePos, x = falsePos, group = model, colour = model)) +
        geom_line() +
        geom_point(shape=1,size=0.1) +
        theme(
            title = element_text(size=15),
            axis.title.x = element_text(size=15),
            axis.text.x  = element_text(size=15),
            legend.position = c(.70, .30),
            legend.background = element_rect(fill = 'grey92', colour = 'black', size=0),
            legend.text=element_text(size=rel(1.2)),
            legend.title=element_text(size=rel(0.8), face="bold", hjust=0)
        ) +
        labs( y="true positive",
              x="false positive",
              title="ROC curves"
        ) +
        scale_colour_manual(values = c("uncompressed" = "#F8766D",
                                       "scheme #1"    = "#F8766D",
                                       "scheme #2"    = "#CD9600",
                                       "scheme #3"    = "#7CAE00",
                                       "scheme #4"    = "#00BE67",
                                       "scheme #5"    = "#00A9FF"
                                     ),
                            breaks = c("uncompressed", "scheme #1", "scheme #2", "scheme #3", "scheme #4", "scheme #5"),
                            labels = c("uncompressed", "scheme #1", "scheme #2", "scheme #3", "scheme #4", "scheme #5")
        ) +
        scale_x_log10()

suppressWarnings( invisible( capture.output( 
  compsPlot #+ xlim(0.75, 0.98)
) ) )

```

*** =right

```{r message = F, echo = F}

tszb1 <- with(tszb,data.frame( ptRef,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],10,0),
                           abs(sat(dPhi12,10)),
                           abs(sat(dPhi23,10)),
                           abs(sat(dPhi34,10)),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           abs(sat(dPhi12,10)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,10)), # analogous to dPhi13
                           abs(sat(dPhi12,10)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,10)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,10)),
                           abs(sat(dPhi23,10)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,10)), # analogous to dPhi24
                           abs(sat(dTheta12,5)),
                           abs(sat(dTheta23,5)),
                           abs(sat(dTheta34,5)),
                           as.factor(ifelse(dTheta23*dTheta12>=0,zero,one)),
                           as.factor(ifelse(dTheta34*dTheta12>=0,zero,one)),
                           abs(sat(dTheta12,5)) + ifelse(dTheta23*dTheta12>=0,one,-one)*abs(sat(dTheta23,5)), # analogous to dTheta13
                           abs(sat(dTheta12,5)) + ifelse(dTheta23*dTheta12>=0,one,-one)*abs(sat(dTheta23,5)) + ifelse(dTheta34*dTheta12>=0,one,-one)*abs(sat(dTheta34,5)),
                           abs(sat(dTheta23,5)) + ifelse(dTheta34*dTheta12>=0,one,-one)*abs(sat(dTheta34,5)), # analogous to dTheta24
                           clct1,
                           clct2,
                           clct3,
                           clct4,
                           fr1,
                           fr2,
                           fr3,
                           fr4
                             )
         )

colnames(tszb1) <- c("ptRef", predictors1 )

invisible( capture.output( tszb1$res <- 1/predict(modelFit1,tszb1)$predictions ) )

rate1  <- sapply(binning, function(x) sum(tszb1$res>x) )

```

```{r message = F, echo = F}

tszb2 <- with(tszb,data.frame( ptRef,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],10,0),
                           abs(sat(dPhi12,7)),
                           abs(sat(dPhi23,5)),
                           abs(sat(dPhi34,5)),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           abs(sat(dPhi12,7)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,5)), # analogous to dPhi13
                           abs(sat(dPhi12,7)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,5)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,5)),
                           abs(sat(dPhi23,5)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,5)), # analogous to dPhi24
                           abs(sat(dTheta12,5)),
                           abs(sat(dTheta23,5)),
                           abs(sat(dTheta34,5)),
                           as.factor(ifelse(dTheta23*dTheta12>=0,zero,one)),
                           as.factor(ifelse(dTheta34*dTheta12>=0,zero,one)),
                           abs(sat(dTheta12,5)) + ifelse(dTheta23*dTheta12>=0,one,-one)*abs(sat(dTheta23,5)), # analogous to dTheta13
                           abs(sat(dTheta12,5)) + ifelse(dTheta23*dTheta12>=0,one,-one)*abs(sat(dTheta23,5)) + ifelse(dTheta34*dTheta12>=0,one,-one)*abs(sat(dTheta34,5)),
                           abs(sat(dTheta23,5)) + ifelse(dTheta34*dTheta12>=0,one,-one)*abs(sat(dTheta34,5)), # analogous to dTheta24
                           clct1,
                           clct2,
                           clct3,
                           clct4,
                           fr1,
                           fr2,
                           fr3,
                           fr4
                             )
         )

colnames(tszb2) <- c("ptRef", predictors2 )

invisible( capture.output( tszb2$res <- 1/predict(modelFit2,tszb2)$predictions ) )

rate2  <- sapply(binning, function(x) sum(tszb2$res>x) )

```

```{r message = F, echo = F}

tszb3 <- with(tszb,data.frame( ptRef,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],7,2),
                           abs(sat(dPhi12,7)),
                           abs(sat(dPhi23,5)),
                           abs(sat(dPhi34,5)),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           abs(sat(dPhi12,7)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,5)), # analogous to dPhi13
                           abs(sat(dPhi12,7)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,5)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,5)),
                           abs(sat(dPhi23,5)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,5)), # analogous to dPhi24
                           abs(sat(dTheta14,3)),
                           clct1,
                           clct2,
                           clct3,
                           clct4,
                           fr1,
                           fr2,
                           fr3,
                           fr4
                             )
         )

colnames(tszb3) <- c("ptRef", predictors3 )

invisible( capture.output( tszb3$res <- 1/predict(modelFit3,tszb3)$predictions ) )

rate3  <- sapply(binning, function(x) sum(tszb3$res>x) )
```

```{r message = F, echo = F}

tszb4 <- with(tszb,data.frame( ptRef,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],7,2),
                           abs(sat(dPhi12,7)),
                           abs(sat(dPhi23,5)),
                           abs(sat(dPhi34,5)),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           abs(sat(dPhi12,7)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,5)), # analogous to dPhi13
                           abs(sat(dPhi12,7)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,5)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,5)),
                           abs(sat(dPhi23,5)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,5)), # analogous to dPhi24
                           abs(sat(dTheta14,3)),
                           clct1,
                           fr1
                             )
         )

colnames(tszb4) <- c("ptRef", predictors4 )

invisible( capture.output( tszb4$res <- 1/predict(modelFit4,tszb4)$predictions ) )

rate4  <- sapply(binning, function(x) sum(tszb4$res>x) )
```

```{r message = F, echo = F}

tszb5 <- with(tszb,data.frame( ptRef,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],7,2),
                           abs(sat(dPhi12,7)),
                           abs(sat(dPhi23,5)),
                           abs(sat(dPhi34,5)),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           abs(sat(dPhi12,7)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,5)), # analogous to dPhi13
                           abs(sat(dPhi12,7)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,5)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,5)),
                           abs(sat(dPhi23,5)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,5)), # analogous to dPhi24
                           abs(sat(dTheta14,3)),
                           c(0,0,0,0,1,1,2,2,3,3,3,0,0,0,0,0)[bitwAnd(as.integer(as.character(clct1)),0xF)+1]
                             )
         )

colnames(tszb5) <- c("ptRef", predictors5 )

invisible( capture.output( tszb5$res <- 1/predict(modelFit5,tszb5)$predictions ) )

rate5  <- sapply(binning, function(x) sum(tszb5$res>x) )

```

```{r, fig.height=4., fig.width=4., fig.align = 'center', comment = NA, message = F, echo = F, dev='svg'}

effRateCompsDF <- data.frame( eff   = roc1[["refEff"]],
                              rate  = myRate,
                              model = rep("uncompressed",nBins)
                )
effRateCompsDF <- rbind( data.frame( eff   = roc1[["myEff"]],
                                     rate  = rate1,
                                     model = rep("scheme #1",nBins)
                       ),
                   effRateCompsDF
                )
effRateCompsDF <- rbind( data.frame( eff   = roc2[["myEff"]],
                                     rate  = rate2,
                                     model = rep("scheme #2",nBins)
                       ),
                   effRateCompsDF
                )
effRateCompsDF <- rbind( data.frame( eff   = roc3[["myEff"]],
                                     rate  = rate3,
                                     model = rep("scheme #3",nBins)
                       ),
                   effRateCompsDF
                )
effRateCompsDF <- rbind( data.frame( eff   = roc4[["myEff"]],
                                     rate  = rate4,
                                     model = rep("scheme #4",nBins)
                       ),
                   effRateCompsDF
                )
effRateCompsDF <- rbind( data.frame( eff   = roc5[["myEff"]],
                                     rate  = rate5,
                                     model = rep("scheme #5",nBins)
                       ),
                   effRateCompsDF
                )

effRateCompsPlot <- ggplot(effRateCompsDF, aes(x = rate, y = eff, group = model, colour = model) ) +
               geom_point(shape=1,size=0.1) + 
               geom_line() + 
               theme(
                    title = element_text(size=15),
                    axis.title.x = element_text(size=15),
                    axis.text.x  = element_text(size=15),
                    legend.position = c(.70, .30),
                    legend.background = element_rect(fill = 'grey92', colour = 'black', size=0),
                    legend.text = element_text(size=rel(1.2)),
                    legend.title = element_text(size=rel(0.8), face="bold", hjust=0)
               ) +
               labs(y = "efficiency",
                    x = "total rate",
                    title = "Efficiency-rate curves"
               ) +
               scale_colour_manual(values = c("uncompressed" = "#F8766D",
                                              "scheme #1"    = "#F8766D",
                                              "scheme #2"    = "#CD9600",
                                              "scheme #3"    = "#7CAE00",
                                              "scheme #4"    = "#00BE67",
                                              "scheme #5"    = "#00A9FF"
                                            ),
                                   breaks = c("uncompressed", "scheme #1", "scheme #2", "scheme #3", "scheme #4", "scheme #5"),
                                   labels = c("uncompressed", "scheme #1", "scheme #2", "scheme #3", "scheme #4", "scheme #5")
               ) +
               scale_x_log10()

suppressWarnings( invisible( capture.output(
  effRateCompsPlot # + xlim(0.5, 1) # + scale_y_log10()
) ) )

```

*** =fullwidth

Bottom-left part of the graphs corresponds to thresholds above ~50 GeV/$c$ $\rightarrow$ ignore $y < 0.8$

Efficiency drop (0.85 < $y$ < 0.95, scheme #1 $\rightarrow$ #2) appears at $\Delta\phi$ precision truncation

Schemes #2,3, and 4 show almost identical performance for thresholds <50&nbsp;GeV/$c$ (top-right)




--- &twocol

## MSB vs LSB in $\Delta\phi$ compression

type | $\theta$ | $\Delta\phi_{12}$ | $\Delta\phi_{23}$ | $\Delta\phi_{34}$ | $S^\phi_{12,23}$ | $S^\phi_{12,34}$ | $\Delta\theta_{14}$ | clct | fr
-----|----------|-------------------|-------------------|-------------------|------------------|------------------|---------------------|------|-----
#3'  |  7       |     `10`          |       10          |        10         |         1        |        1         |       [3:0]         | 4,4,4,4 | 1,1,1,1 
#5'  |  [7:2]   |  `[10:3]`         |   `[5:0]`         |      `[5:0]`      |         1        |        1         |       [2:0]         | 2,0,0,0 | 1,0,0,0 
#5'' |  [7:2]   |  `[10:3]`         |   `[8:3]`         |      `[8:3]`      |         1        |        1         |       [2:0]         | 2,0,0,0 | 1,0,0,0

```{r message = F, echo = F}
# type #3'

vars3p <- with(vars,data.frame( muPtGenInv,
                                ptTrg,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],7,0),
                           abs(sat(dPhi12,10)),
                           abs(sat(dPhi23,10)),
                           abs(sat(dPhi34,10)),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           abs(sat(dPhi12,10)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,10)), # analogous to dPhi13
                           abs(sat(dPhi12,10)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,10)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,10)),
                           abs(sat(dPhi23,10)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,10)), # analogous to dPhi24
                           abs(sat(dTheta14,3)),
                           clct1,
                           clct2,
                           clct3,
                           clct4,
                           fr1,
                           fr2,
                           fr3,
                           fr4
                             )
         )

colnames(vars3p) <- c("muPtGenInv", "ptTrg", predictors3 )

set.seed(1)

trainSet3p <- vars3p[part,]
testSet3p <- vars3p[-part,]

invisible( capture.output( modelFit3p <- ranger(f3, data=trainSet3p, importance="impurity") ) )
```

```{r message = F, echo = F}
# type #5'

vars5p <- with(vars,data.frame( muPtGenInv,
                                ptTrg,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],7,2),
                           msb(abs(sat(dPhi12,10)),10,3),
                           abs(sat(dPhi23,5)),
                           abs(sat(dPhi34,5)),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           msb(abs(sat(dPhi12,10)),10,3) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,5)), # analogous to dPhi13
                           msb(abs(sat(dPhi12,10)),10,3) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,5)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,5)),
                           abs(sat(dPhi23,5))            + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,5)), # analogous to dPhi24
                           abs(sat(dTheta14,2)),
                           c(0,0,0,0,1,1,2,2,3,3,3,0,0,0,0,0)[bitwAnd(as.integer(as.character(clct1)),0xF)+1],
                           fr1
                             )
         )

colnames(vars5p) <- c("muPtGenInv", "ptTrg", predictors4) # predictors5, "fr1" )

set.seed(1)

trainSet5p <- vars5p[part,]
testSet5p <- vars5p[-part,]

invisible( capture.output( modelFit5p <- ranger(f4, data=trainSet5p, importance="impurity") ) )

```

```{r message = F, echo = F}
# type #5''

vars5pp <- with(vars,data.frame( muPtGenInv,
                                 ptTrg,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],7,2),
                           msb(abs(sat(dPhi12,10)),10,3),
                           msb(abs(sat(dPhi23,8)),8,3),
                           msb(abs(sat(dPhi34,8)),8,3),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           msb(abs(sat(dPhi12,10)),10,3) + ifelse(dPhi23*dPhi12>=0,one,-one)*msb(abs(sat(dPhi23,8)),8,3), # analogous to dPhi13
                           msb(abs(sat(dPhi12,10)),10,3) + ifelse(dPhi23*dPhi12>=0,one,-one)*msb(abs(sat(dPhi23,8)),8,3) + ifelse(dPhi34*dPhi12>=0,one,-one)*msb(abs(sat(dPhi34,8)),8,3),
                           msb(abs(sat(dPhi23,8)),8,3)   + ifelse(dPhi34*dPhi12>=0,one,-one)*msb(abs(sat(dPhi34,8)),8,3), # analogous to dPhi24
                           abs(sat(dTheta14,2)),
                           c(0,0,0,0,1,1,2,2,3,3,3,0,0,0,0,0)[bitwAnd(as.integer(as.character(clct1)),0xF)+1],
                           fr1
                             )
         )

colnames(vars5pp) <- c("muPtGenInv", "ptTrg", predictors4) # predictors5, "fr1" )

set.seed(1)

trainSet5pp <- vars5pp[part,]
testSet5pp <- vars5pp[-part,]

invisible( capture.output( modelFit5pp <- ranger(f4, data=trainSet5pp, importance="impurity") ) )
```


```{r message = F, echo = F}

tszb3p <- with(tszb,data.frame( ptRef,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],7,0),
                           abs(sat(dPhi12,10)),
                           abs(sat(dPhi23,10)),
                           abs(sat(dPhi34,10)),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           abs(sat(dPhi12,10)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,10)), # analogous to dPhi13
                           abs(sat(dPhi12,10)) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,10)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,10)),
                           abs(sat(dPhi23,10)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,10)), # analogous to dPhi24
                           abs(sat(dTheta14,3)),
                           clct1,
                           clct2,
                           clct3,
                           clct4,
                           fr1,
                           fr2,
                           fr3,
                           fr4
                             )
         )

colnames(tszb3p) <- c("ptRef", predictors3 )

invisible( capture.output( tszb3p$res <- 1/predict(modelFit3p,tszb3p)$predictions ) )

rate3p  <- sapply(binning, function(x) sum(tszb3p$res>x) )

```

```{r message = F, echo = F}

tszb5p <- with(tszb,data.frame( ptRef,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],7,2),
                           msb(abs(sat(dPhi12,10)),10,3),
                           abs(sat(dPhi23,5)),
                           abs(sat(dPhi34,5)),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           msb(abs(sat(dPhi12,10)),10,3) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,5)), # analogous to dPhi13
                           msb(abs(sat(dPhi12,10)),10,3) + ifelse(dPhi23*dPhi12>=0,one,-one)*abs(sat(dPhi23,5)) + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,5)),
                           abs(sat(dPhi23,5))            + ifelse(dPhi34*dPhi12>=0,one,-one)*abs(sat(dPhi34,5)), # analogous to dPhi24
                           abs(sat(dTheta14,2)),
                           c(0,0,0,0,1,1,2,2,3,3,3,0,0,0,0,0)[bitwAnd(as.integer(as.character(clct1)),0xF)+1],
                           fr1
                             )
         )

colnames(tszb5p) <- c("ptRef", predictors5, "fr1" )

invisible( capture.output( tszb5p$res <- 1/predict(modelFit5p,tszb5p)$predictions ) )

rate5p  <- sapply(binning, function(x) sum(tszb5p$res>x) )

```

```{r message = F, echo = F}

tszb5pp <- with(tszb,data.frame( ptRef,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],7,2),
                           msb(abs(sat(dPhi12,10)),10,3),
                           msb(abs(sat(dPhi23,8)),8,3),
                           msb(abs(sat(dPhi34,8)),8,3),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           msb(abs(sat(dPhi12,10)),10,3) + ifelse(dPhi23*dPhi12>=0,one,-one)*msb(abs(sat(dPhi23,8)),8,3), # analogous to dPhi13
                           msb(abs(sat(dPhi12,10)),10,3) + ifelse(dPhi23*dPhi12>=0,one,-one)*msb(abs(sat(dPhi23,8)),8,3) + ifelse(dPhi34*dPhi12>=0,one,-one)*msb(abs(sat(dPhi34,8)),8,3),
                           msb(abs(sat(dPhi23,8)),8,3)   + ifelse(dPhi34*dPhi12>=0,one,-one)*msb(abs(sat(dPhi34,8)),8,3), # analogous to dPhi24
                           abs(sat(dTheta14,2)),
                           c(0,0,0,0,1,1,2,2,3,3,3,0,0,0,0,0)[bitwAnd(as.integer(as.character(clct1)),0xF)+1],
                           fr1
                             )
         )

colnames(tszb5pp) <- c("ptRef", predictors5, "fr1" )

invisible( capture.output( tszb5pp$res <- 1/predict(modelFit5pp,tszb5pp)$predictions ) )

rate5pp  <- sapply(binning, function(x) sum(tszb5pp$res>x) )

```

```{r message = F, echo = F}
invisible( capture.output(
pp3p <- preprocess( modelFit = modelFit3p,
                    testSet  = testSet3p,
                    rateShapeBinned,
                    binning
                  )
) )
myTurnOnComp3p <- pp3p$getMyTurnOn()
```

```{r message = F, echo = F}
invisible( capture.output(
pp5p <- preprocess( modelFit = modelFit5p,
                    testSet  = testSet5p,
                    rateShapeBinned,
                    binning
                  )
) )
myTurnOnComp5p <- pp5p$getMyTurnOn()
```

```{r message = F, echo = F}
invisible( capture.output(
pp5pp <- preprocess( modelFit = modelFit5pp,
                     testSet  = testSet5pp,
                     rateShapeBinned,
                     binning
                   )
) )
myTurnOnComp5pp <- pp5pp$getMyTurnOn()
```

*** =left

```{r, fig.height=3.5, fig.width=4., fig.align = 'center', comment = NA, message = F, echo = F, dev='svg'}

roc3p <- rocMetric( rateShapeBinned = rateShapeBinned,
                    myModelTurnOn = myTurnOnComp3p,
                    referenceTurnOn = refTurnOn,
                    binning = binning,
                    refScale = 1.43
         )

roc5p <- rocMetric( rateShapeBinned = rateShapeBinned,
                    myModelTurnOn = myTurnOnComp5p,
                    referenceTurnOn = myTurnOnComp1,
                    binning = binning,
                    refScale = 1.0
         )

roc5pp <- rocMetric( rateShapeBinned = rateShapeBinned,
                     myModelTurnOn = myTurnOnComp5pp,
                     referenceTurnOn = myTurnOn,
                     binning = binning,
                     refScale = 1.0
          )

refModelROCdf <- data.frame( truePos  = roc3p[["refEff"]],
                             falsePos = roc3p[["refFake"]],
                             model    = rep("baseline",nBins)
                 )
myModelROCdf <- data.frame( truePos  = roc1[["refEff"]],  #roc5p[["refEff"]],
                            falsePos = roc1[["refFake"]], #roc5p[["refFake"]],
                            model    = rep("uncompres.",nBins)
                )
comp3pROCdf   <- data.frame( truePos  = roc3p[["myEff"]],
                             falsePos = roc3p[["myFake"]],
                             model    = rep("scheme #3'",nBins)
                 )
comp5pROCdf   <- data.frame( truePos  = roc5p[["myEff"]],
                             falsePos = roc5p[["myFake"]],
                             model    = rep("scheme #5'",nBins)
                 )
comp5ppROCdf   <- data.frame( truePos  = roc5pp[["myEff"]],
                              falsePos = roc5pp[["myFake"]],
                              model    = rep("scheme #5''",nBins)
                  )

start <- sum(rateShapeBinned==0) + 1
myModelROCdf    <- myModelROCdf [start:nBins,]
refModelROCdf   <- refModelROCdf[start:nBins,]
comp3pROCdf     <- comp3pROCdf  [start:nBins,]
comp5pROCdf     <- comp5pROCdf  [start:nBins,]
comp5ppROCdf    <- comp5ppROCdf [start:nBins,]

#compspDF <- myModelROCdf
#compspDF <- rbind(compspDF,refModelROCdf)
#compspDF <- rbind(compspDF,comp3pROCdf)
compspDF <- comp3pROCdf
compspDF <- rbind(compspDF,comp5pROCdf)
compspDF <- rbind(compspDF,comp5ppROCdf)

compspPlot <- ggplot(compspDF, aes(y = truePos, x = falsePos, group = model, colour = model)) +
        geom_line() +
        geom_point(shape=1,size=0.1) +
        theme(
            title = element_text(size=15),
            axis.title.x = element_text(size=15),
            axis.text.x  = element_text(size=15),
            legend.position = c(.20, .78),
            legend.background = element_rect(fill = 'grey92', colour = 'black', size=0),
            legend.text=element_text(size=rel(1.2)),
            legend.title=element_blank()  #element_text(size=rel(0.8), face="bold", hjust=0)
        ) +
        labs( y="true positive",
              x="false positive",
              title="ROC curves"
        ) +
        scale_colour_manual(values = c(
#                                       "baseline"     = "#F8766D",
#                                       "uncompres."   = "#7CAE00",
                                       "scheme #3'"   = "#CD9600",
                                       "scheme #5'"   = "#00BE67",
                                       "scheme #5''"  = "#00A9FF"
                                     ),
                            breaks = c(
#                                       "baseline",
#                                       "uncompres.",
                                       "scheme #3'",
                                       "scheme #5'",
                                       "scheme #5''"
                                     ),
                            labels = c(
#                                       "baseline",
#                                       "uncompres.",
                                       "scheme #3'",
                                       "scheme #5'",
                                       "scheme #5''"
                                     )
        ) +
        scale_x_log10(limits = c(0.0001,1))

suppressWarnings( invisible( capture.output( 
  compspPlot + ylim(0.75,1)
) ) )

```

*** =right


```{r, fig.height=3.5, fig.width=4., fig.align = 'center', comment = NA, message = F, echo = F, dev='svg'}

#effRateCompspDF <- data.frame( eff  = roc[["refEff"]],
#                              rate  = refRate,
#                              model = rep("baseline",nBins)
#                )
#
#effRateCompspDF <- rbind( data.frame( eff   = roc1[["refEff"]], # roc1[["myEff"]], # scheme 1
#                                      rate  = myRate, # rate1
#                                      model = rep("uncompres.",nBins)
#                          ),
#                          effRateCompspDF
#                   )
effRateCompspDF <- #rbind( 
                          data.frame( eff   = roc3p[["myEff"]],
                                      rate  = rate3p,
                                      model = rep("scheme #3'",nBins)
                          )#,
#                          effRateCompspDF
#                   )
effRateCompspDF <- rbind( data.frame( eff   = roc5p[["myEff"]],
                                     rate  = rate5p,
                                     model = rep("scheme #5'",nBins)
                          ),
                          effRateCompspDF
                   )
effRateCompspDF <- rbind( data.frame( eff   = roc5pp[["myEff"]],
                                     rate  = rate5pp,
                                     model = rep("scheme #5''",nBins)
                          ),
                          effRateCompspDF
                   )

effRateCompspPlot <- ggplot(effRateCompspDF, aes(x = rate, y = eff, group = model, colour = model) ) +
               geom_point(shape=1,size=0.1) + 
               geom_line() + 
               theme(
                    title = element_text(size=15),
                    axis.title.x = element_text(size=15),
                    axis.text.x  = element_text(size=15),
                    legend.position = c(.20, .78),
                    legend.background = element_rect(fill = 'grey92', colour = 'black', size=0),
                    legend.text = element_text(size=rel(1.2)),
                    legend.title = element_blank() #element_text(size=rel(0.8), face="bold", hjust=0)
               ) +
               labs(y = "efficiency",
                    x = "total rate",
                    title = "Efficiency-rate curves"
               ) +
               scale_colour_manual(values = c(
#                                              "baseline"     = "#F8766D",
#                                              "uncompres."   = "#7CAE00",
                                              "scheme #3'"   = "#CD9600",
                                              "scheme #5'"   = "#00BE67",
                                              "scheme #5''"  = "#00A9FF"
                                            ),
                                   breaks = c(
#                                              "baseline",
#                                              "uncompres.",
                                              "scheme #3'",
                                              "scheme #5'",
                                              "scheme #5''"
                                            ),
                                   labels = c(
#                                              "baseline",
#                                              "uncompres.",
                                              "scheme #3'",
                                              "scheme #5'",
                                              "scheme #5''"
                                            )
               ) +
               scale_x_log10(limits = c(30,30000))

suppressWarnings( invisible( capture.output(
  effRateCompspPlot + ylim(0.75, 1)
) ) )

```

*** =fullwidth

Chopping off LSBs of $\Delta\phi$ affects high-pT muons (bottom-left) and MSBs - low-pT (top-right)



--- &twocol

## MSB vs LSB in $\Delta\phi$ compression (2)

type| $\theta$ | $\Delta\phi_{12}$ | $\Delta\phi_{23}$ | $\Delta\phi_{34}$ | $S^\phi_{12,23}$ | $S^\phi_{12,34}$ | $\Delta\theta_{14}$ | clct | fr
----|----------|-------------------|-------------------|-------------------|------------------|------------------|---------------------|------|-----
#3' |  7       |      10           |       10          |        10         |         1        |        1         |       [3:0]         | 4,4,4,4 | 1,1,1,1
#6  |  [7:2]   |   `[9:2]`         |     `[8:3]`       |      `[8:3]`      |         1        |        1         |       [2:0]         | 2,0,0,0 | 1,0,0,0
#7  |  [7:2]   |   `[9:2]`         |     `[7:2]`       |      `[7:2]`      |         1        |        1         |       [2:0]         | 2,0,0,0 | 1,0,0,0

```{r message = F, echo = F}
# type #6

vars6 <- with(vars,data.frame( muPtGenInv,
                               ptTrg,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],7,2),
                           msb(abs(sat(dPhi12,9)),9,2),
                           msb(abs(sat(dPhi23,8)),8,3),
                           msb(abs(sat(dPhi34,8)),8,3),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           msb(abs(sat(dPhi12,9)),9,2) + ifelse(dPhi23*dPhi12>=0,one,-one)*msb(abs(sat(dPhi23,8)),8,3), # analogous to dPhi13
                           msb(abs(sat(dPhi12,9)),9,2) + ifelse(dPhi23*dPhi12>=0,one,-one)*msb(abs(sat(dPhi23,8)),8,3) + ifelse(dPhi34*dPhi12>=0,one,-one)*msb(abs(sat(dPhi34,8)),8,3),
                           msb(abs(sat(dPhi23,8)),8,3) + ifelse(dPhi34*dPhi12>=0,one,-one)*msb(abs(sat(dPhi34,8)),8,3), # analogous to dPhi24
                           abs(sat(dTheta14,2)),
                           c(0,0,0,0,1,1,2,2,3,3,3,0,0,0,0,0)[bitwAnd(as.integer(as.character(clct1)),0xF)+1],
                           fr1
                             )
         )

colnames(vars6) <- c("muPtGenInv", "ptTrg", predictors4)

set.seed(1)

trainSet6 <- vars6[part,]
testSet6 <- vars6[-part,]

invisible( capture.output( modelFit6 <- ranger(f4, data=trainSet6, importance="impurity") ) )

```

```{r message = F, echo = F}
# type #7

vars7 <- with(vars,data.frame( muPtGenInv,
                               ptTrg,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],7,2),
                           msb(abs(sat(dPhi12,9)),9,2),
                           msb(abs(sat(dPhi23,7)),7,2),
                           msb(abs(sat(dPhi34,7)),7,2),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           msb(abs(sat(dPhi12,9)),9,2) + ifelse(dPhi23*dPhi12>=0,one,-one)*msb(abs(sat(dPhi23,7)),7,2), # analogous to dPhi13
                           msb(abs(sat(dPhi12,9)),9,2) + ifelse(dPhi23*dPhi12>=0,one,-one)*msb(abs(sat(dPhi23,7)),7,2) + ifelse(dPhi34*dPhi12>=0,one,-one)*msb(abs(sat(dPhi34,7)),7,2),
                           msb(abs(sat(dPhi23,7)),7,2) + ifelse(dPhi34*dPhi12>=0,one,-one)*msb(abs(sat(dPhi34,7)),7,2), # analogous to dPhi24
                           abs(sat(dTheta14,2)),
                           c(0,0,0,0,1,1,2,2,3,3,3,0,0,0,0,0)[bitwAnd(as.integer(as.character(clct1)),0xF)+1],
                           fr1
                             )
         )

colnames(vars7) <- c("muPtGenInv", "ptTrg", predictors4)

set.seed(1)

trainSet7 <- vars7[part,]
testSet7 <- vars7[-part,]

invisible( capture.output( modelFit7 <- ranger(f4, data=trainSet7, importance="impurity") ) )
```

```{r message = F, echo = F}

tszb6 <- with(tszb,data.frame( ptRef,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],7,2),
                           msb(abs(sat(dPhi12,9)),9,2),
                           msb(abs(sat(dPhi23,8)),8,3),
                           msb(abs(sat(dPhi34,8)),8,3),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           msb(abs(sat(dPhi12,9)),9,2) + ifelse(dPhi23*dPhi12>=0,one,-one)*msb(abs(sat(dPhi23,8)),8,3), # analogous to dPhi13
                           msb(abs(sat(dPhi12,9)),9,2) + ifelse(dPhi23*dPhi12>=0,one,-one)*msb(abs(sat(dPhi23,8)),8,3) + ifelse(dPhi34*dPhi12>=0,one,-one)*msb(abs(sat(dPhi34,8)),8,3),
                           msb(abs(sat(dPhi23,8)),8,3) + ifelse(dPhi34*dPhi12>=0,one,-one)*msb(abs(sat(dPhi34,8)),8,3), # analogous to dPhi24
                           abs(sat(dTheta14,2)),
                           c(0,0,0,0,1,1,2,2,3,3,3,0,0,0,0,0)[bitwAnd(as.integer(as.character(clct1)),0xF)+1],
                           fr1
                             )
         )

colnames(tszb6) <- c("ptRef", predictors4)

invisible( capture.output( tszb6$res <- 1/predict(modelFit6,tszb6)$predictions ) )

rate6  <- sapply(binning, function(x) sum(tszb6$res>x) )

```

```{r message = F, echo = F}

tszb7 <- with(tszb,data.frame( ptRef,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],7,2),
                           msb(abs(sat(dPhi12,9)),9,2),
                           msb(abs(sat(dPhi23,7)),7,2),
                           msb(abs(sat(dPhi34,7)),7,2),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           msb(abs(sat(dPhi12,9)),9,2) + ifelse(dPhi23*dPhi12>=0,one,-one)*msb(abs(sat(dPhi23,7)),7,2), # analogous to dPhi13
                           msb(abs(sat(dPhi12,9)),9,2) + ifelse(dPhi23*dPhi12>=0,one,-one)*msb(abs(sat(dPhi23,7)),7,2) + ifelse(dPhi34*dPhi12>=0,one,-one)*msb(abs(sat(dPhi34,7)),7,2),
                           msb(abs(sat(dPhi23,7)),7,2) + ifelse(dPhi34*dPhi12>=0,one,-one)*msb(abs(sat(dPhi34,7)),7,2), # analogous to dPhi24
                           abs(sat(dTheta14,2)),
                           c(0,0,0,0,1,1,2,2,3,3,3,0,0,0,0,0)[bitwAnd(as.integer(as.character(clct1)),0xF)+1],
                           fr1
                             )
         )

colnames(tszb7) <- c("ptRef", predictors4)

invisible( capture.output( tszb7$res <- 1/predict(modelFit7,tszb7)$predictions ) )

rate7  <- sapply(binning, function(x) sum(tszb7$res>x) )

```

```{r message = F, echo = F}
invisible( capture.output(
pp6 <- preprocess( modelFit = modelFit6,
                   testSet  = testSet6,
                   rateShapeBinned,
                   binning
                 )
) )
myTurnOnComp6 <- pp6$getMyTurnOn()
```

```{r message = F, echo = F}
invisible( capture.output(
pp7 <- preprocess( modelFit = modelFit7,
                   testSet  = testSet7,
                   rateShapeBinned,
                   binning
                 )
) )
myTurnOnComp7 <- pp7$getMyTurnOn()
```

*** =left

```{r, fig.height=3.5, fig.width=4., fig.align = 'center', comment = NA, message = F, echo = F, dev='svg'}



roc6 <- rocMetric( rateShapeBinned = rateShapeBinned,
                   myModelTurnOn = myTurnOnComp6,
                   referenceTurnOn = myTurnOnComp1,
                   binning = binning,
                   refScale = 1.0
        )

roc7 <- rocMetric( rateShapeBinned = rateShapeBinned,
                   myModelTurnOn = myTurnOnComp7,
                   referenceTurnOn = myTurnOn,
                   binning = binning,
                   refScale = 1.0
        )

comp6ROCdf   <- data.frame( truePos  = roc6[["myEff"]],
                            falsePos = roc6[["myFake"]],
                            model    = rep("scheme #6",nBins)
                )
comp7ROCdf   <- data.frame( truePos  = roc7[["myEff"]],
                            falsePos = roc7[["myFake"]],
                            model    = rep("scheme #7",nBins)
                )

start <- sum(rateShapeBinned==0) + 1
comp6ROCdf   <- comp6ROCdf [start:nBins,]
comp7ROCdf   <- comp7ROCdf [start:nBins,]

comps67DF <- comp3pROCdf
comps67DF <- rbind(comps67DF,comp6ROCdf)
comps67DF <- rbind(comps67DF,comp7ROCdf)

comps67Plot <- ggplot(comps67DF, aes(y = truePos, x = falsePos, group = model, colour = model)) +
        geom_line() +
        geom_point(shape=1,size=0.1) +
        theme(
            title = element_text(size=15),
            axis.title.x = element_text(size=15),
            axis.text.x  = element_text(size=15),
            legend.position = c(.20, .78),
            legend.background = element_rect(fill = 'grey92', colour = 'black', size=0),
            legend.text=element_text(size=rel(1.2)),
            legend.title=element_blank()  #element_text(size=rel(0.8), face="bold", hjust=0)
        ) +
        labs( y="true positive",
              x="false positive",
              title="ROC curves"
        ) +
        scale_colour_manual(values = c(
                                       "scheme #3'" = "#CD9600",
                                       "scheme #6"  = "#00BE67",
                                       "scheme #7"  = "#00A9FF"
                                     ),
                            breaks = c(
                                       "scheme #3'",
                                       "scheme #6",
                                       "scheme #7"
                                     ),
                            labels = c(
                                       "scheme #3'",
                                       "scheme #6",
                                       "scheme #7"
                                     )
        ) +
        scale_x_log10(limits = c(0.0001,1))

suppressWarnings( invisible( capture.output( 
  comps67Plot + ylim(0.75,1)
) ) )

```

*** =right

```{r, fig.height=3.5, fig.width=4., fig.align = 'center', comment = NA, message = F, echo = F, dev='svg'}

effRateComps67DF <-
                          data.frame(eff   = roc3p[["myEff"]],
                                     rate  = rate3p,
                                     model = rep("scheme #3'",nBins)
                          )
effRateComps67DF <- rbind( data.frame( eff   = roc6[["myEff"]],
                                       rate  = rate6,
                                       model = rep("scheme #6",nBins)
                          ),
                          effRateComps67DF
                    )
effRateComps67DF <- rbind( data.frame( eff   = roc7[["myEff"]],
                                       rate  = rate7,
                                       model = rep("scheme #7",nBins)
                           ),
                           effRateComps67DF
                    )

effRateComps67Plot <- ggplot(effRateComps67DF, aes(x = rate, y = eff, group = model, colour = model) ) +
               geom_point(shape=1,size=0.1) + 
               geom_line() + 
               theme(
                    title = element_text(size=15),
                    axis.title.x = element_text(size=15),
                    axis.text.x  = element_text(size=15),
                    legend.position = c(.20, .78),
                    legend.background = element_rect(fill = 'grey92', colour = 'black', size=0),
                    legend.text = element_text(size=rel(1.2)),
                    legend.title = element_blank() #element_text(size=rel(0.8), face="bold", hjust=0)
               ) +
               labs(y = "efficiency",
                    x = "total rate",
                    title = "Efficiency-rate curves"
               ) +
               scale_colour_manual(values = c(
                                              "scheme #3'" = "#CD9600",
                                              "scheme #6"  = "#00BE67",
                                              "scheme #7"  = "#00A9FF"
                                            ),
                                   breaks = c(
                                              "scheme #3'",
                                              "scheme #6",
                                              "scheme #7"
                                            ),
                                   labels = c(
                                              "scheme #3'",
                                              "scheme #6",
                                              "scheme #7"
                                            )
               ) +
               scale_x_log10(limits = c(30,30000))

suppressWarnings( invisible( capture.output(
  effRateComps67Plot + ylim(0.75, 1)
) ) )

```

*** =fullwidth

Scheme #7 is marginally better than #6; both get close to 'no compression' scheme #3'



--- &twocol

## MSB vs LSB in $\Delta\phi$ compression (3)

type| $\theta$ | $\Delta\phi_{12}$ | $\Delta\phi_{23}$ | $\Delta\phi_{34}$ | $S^\phi_{12,23}$ | $S^\phi_{12,34}$ | $\Delta\theta_{14}$ | clct | fr
----|----------|-------------------|-------------------|-------------------|------------------|------------------|---------------------|------|-----
#3' |  7       |      10           |       10          |        10         |         1        |        1         |       [3:0]         | 4,4,4,4 | 1,1,1,1
#8  |  [7:3]   |   `[10:2]`        |     `[7:2]`       |      `[7:2]`      |         1        |        1         |       [2:0]         | 2,0,0,0 | 1,0,0,0
#9  |  [7:3]   |   `[9:1]`         |     `[7:2]`       |      `[7:2]`      |         1        |        1         |       [2:0]         | 2,0,0,0 | 1,0,0,0

```{r message = F, echo = F}
# type #8

vars8 <- with(vars,data.frame( muPtGenInv,
                               ptTrg,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],7,3),
                           msb(abs(sat(dPhi12,10)),10,2),
                           msb(abs(sat(dPhi23,7)),7,2),
                           msb(abs(sat(dPhi34,7)),7,2),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           msb(abs(sat(dPhi12,10)),10,2) + ifelse(dPhi23*dPhi12>=0,one,-one)*msb(abs(sat(dPhi23,7)),7,2), # analogous to dPhi13
                           msb(abs(sat(dPhi12,10)),10,2) + ifelse(dPhi23*dPhi12>=0,one,-one)*msb(abs(sat(dPhi23,7)),7,2) + ifelse(dPhi34*dPhi12>=0,one,-one)*msb(abs(sat(dPhi34,7)),7,2),
                           msb(abs(sat(dPhi23,7)),7,2)   + ifelse(dPhi34*dPhi12>=0,one,-one)*msb(abs(sat(dPhi34,7)),7,2), # analogous to dPhi24
                           abs(sat(dTheta14,2)),
                           c(0,0,0,0,1,1,2,2,3,3,3,0,0,0,0,0)[bitwAnd(as.integer(as.character(clct1)),0xF)+1],
                           fr1
                             )
         )

colnames(vars8) <- c("muPtGenInv", "ptTrg", predictors4)

set.seed(1)

trainSet8 <- vars8[part,]
testSet8 <- vars8[-part,]

invisible( capture.output( modelFit8 <- ranger(f4, data=trainSet8, importance="impurity") ) )

```

```{r message = F, echo = F}
# type #9

vars9 <- with(vars,data.frame( muPtGenInv,
                               ptTrg,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],7,3),
                           msb(abs(sat(dPhi12,9)),9,1),
                           msb(abs(sat(dPhi23,7)),7,2),
                           msb(abs(sat(dPhi34,7)),7,2),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           msb(abs(sat(dPhi12,9)),9,1) + ifelse(dPhi23*dPhi12>=0,one,-one)*msb(abs(sat(dPhi23,7)),7,2), # analogous to dPhi13
                           msb(abs(sat(dPhi12,9)),9,1) + ifelse(dPhi23*dPhi12>=0,one,-one)*msb(abs(sat(dPhi23,7)),7,2) + ifelse(dPhi34*dPhi12>=0,one,-one)*msb(abs(sat(dPhi34,7)),7,2),
                           msb(abs(sat(dPhi23,7)),7,2) + ifelse(dPhi34*dPhi12>=0,one,-one)*msb(abs(sat(dPhi34,7)),7,2), # analogous to dPhi24
                           abs(sat(dTheta14,2)),
                           c(0,0,0,0,1,1,2,2,3,3,3,0,0,0,0,0)[bitwAnd(as.integer(as.character(clct1)),0xF)+1],
                           fr1
                             )
         )

colnames(vars9) <- c("muPtGenInv", "ptTrg", predictors4)

set.seed(1)

trainSet9 <- vars9[part,]
testSet9 <- vars9[-part,]

invisible( capture.output( modelFit9 <- ranger(f4, data=trainSet9, importance="impurity") ) )
```

```{r message = F, echo = F}

tszb8 <- with(tszb,data.frame( ptRef,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],7,3),
                           msb(abs(sat(dPhi12,10)),10,2),
                           msb(abs(sat(dPhi23,7)),7,2),
                           msb(abs(sat(dPhi34,7)),7,2),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           msb(abs(sat(dPhi12,10)),10,2) + ifelse(dPhi23*dPhi12>=0,one,-one)*msb(abs(sat(dPhi23,7)),7,2), # analogous to dPhi13
                           msb(abs(sat(dPhi12,10)),10,2) + ifelse(dPhi23*dPhi12>=0,one,-one)*msb(abs(sat(dPhi23,7)),7,2) + ifelse(dPhi34*dPhi12>=0,one,-one)*msb(abs(sat(dPhi34,7)),7,2),
                           msb(abs(sat(dPhi23,7)),7,2)   + ifelse(dPhi34*dPhi12>=0,one,-one)*msb(abs(sat(dPhi34,7)),7,2), # analogous to dPhi24
                           abs(sat(dTheta14,2)),
                           c(0,0,0,0,1,1,2,2,3,3,3,0,0,0,0,0)[bitwAnd(as.integer(as.character(clct1)),0xF)+1],
                           fr1
                             )
         )

colnames(tszb8) <- c("ptRef", predictors4)

invisible( capture.output( tszb8$res <- 1/predict(modelFit8,tszb8)$predictions ) )

rate8  <- sapply(binning, function(x) sum(tszb8$res>x) )

```

```{r message = F, echo = F}

tszb9 <- with(tszb,data.frame( ptRef,
                           msb(theta + c(0,6,6,0)[as.integer(as.character(ring1))],7,3),
                           msb(abs(sat(dPhi12,9)),9,1),
                           msb(abs(sat(dPhi23,7)),7,2),
                           msb(abs(sat(dPhi34,7)),7,2),
                           as.factor(ifelse(dPhi23*dPhi12>=0,zero,one)),
                           as.factor(ifelse(dPhi34*dPhi12>=0,zero,one)),
                           msb(abs(sat(dPhi12,9)),9,1) + ifelse(dPhi23*dPhi12>=0,one,-one)*msb(abs(sat(dPhi23,7)),7,2), # analogous to dPhi13
                           msb(abs(sat(dPhi12,9)),9,1) + ifelse(dPhi23*dPhi12>=0,one,-one)*msb(abs(sat(dPhi23,7)),7,2) + ifelse(dPhi34*dPhi12>=0,one,-one)*msb(abs(sat(dPhi34,7)),7,2),
                           msb(abs(sat(dPhi23,7)),7,2) + ifelse(dPhi34*dPhi12>=0,one,-one)*msb(abs(sat(dPhi34,7)),7,2), # analogous to dPhi24
                           abs(sat(dTheta14,2)),
                           c(0,0,0,0,1,1,2,2,3,3,3,0,0,0,0,0)[bitwAnd(as.integer(as.character(clct1)),0xF)+1],
                           fr1
                             )
         )

colnames(tszb9) <- c("ptRef", predictors4)

invisible( capture.output( tszb9$res <- 1/predict(modelFit9,tszb9)$predictions ) )

rate9  <- sapply(binning, function(x) sum(tszb9$res>x) )

```

```{r message = F, echo = F}
invisible( capture.output(
pp8 <- preprocess( modelFit = modelFit8,
                   testSet  = testSet8,
                   rateShapeBinned,
                   binning
                 )
) )
myTurnOnComp8 <- pp8$getMyTurnOn()
```

```{r message = F, echo = F}
invisible( capture.output(
pp9 <- preprocess( modelFit = modelFit9,
                   testSet  = testSet9,
                   rateShapeBinned,
                   binning
                 )
) )
myTurnOnComp9 <- pp9$getMyTurnOn()
```

*** =left

```{r, fig.height=3.5, fig.width=4., fig.align = 'center', comment = NA, message = F, echo = F, dev='svg'}



roc8 <- rocMetric( rateShapeBinned = rateShapeBinned,
                   myModelTurnOn = myTurnOnComp8,
                   referenceTurnOn = myTurnOnComp1,
                   binning = binning,
                   refScale = 1.0
        )

roc9 <- rocMetric( rateShapeBinned = rateShapeBinned,
                   myModelTurnOn = myTurnOnComp9,
                   referenceTurnOn = myTurnOn,
                   binning = binning,
                   refScale = 1.0
        )

comp8ROCdf   <- data.frame( truePos  = roc8[["myEff"]],
                            falsePos = roc8[["myFake"]],
                            model    = rep("scheme #8",nBins)
                )
comp9ROCdf   <- data.frame( truePos  = roc9[["myEff"]],
                            falsePos = roc9[["myFake"]],
                            model    = rep("scheme #9",nBins)
                )

start <- sum(rateShapeBinned==0) + 1
comp8ROCdf   <- comp8ROCdf [start:nBins,]
comp9ROCdf   <- comp9ROCdf [start:nBins,]

comps89DF <- comp3pROCdf
comps89DF <- rbind(comps89DF,comp8ROCdf)
comps89DF <- rbind(comps89DF,comp9ROCdf)

comps89Plot <- ggplot(comps89DF, aes(y = truePos, x = falsePos, group = model, colour = model)) +
        geom_line() +
        geom_point(shape=1,size=0.1) +
        theme(
            title = element_text(size=15),
            axis.title.x = element_text(size=15),
            axis.text.x  = element_text(size=15),
            legend.position = c(.20, .78),
            legend.background = element_rect(fill = 'grey92', colour = 'black', size=0),
            legend.text=element_text(size=rel(1.2)),
            legend.title=element_blank()  #element_text(size=rel(0.8), face="bold", hjust=0)
        ) +
        labs( y="true positive",
              x="false positive",
              title="ROC curves"
        ) +
        scale_colour_manual(values = c(
                                       "scheme #3'" = "#CD9600",
                                       "scheme #8"  = "#00BE67",
                                       "scheme #9"  = "#00A9FF"
                                     ),
                            breaks = c(
                                       "scheme #3'",
                                       "scheme #8",
                                       "scheme #9"
                                     ),
                            labels = c(
                                       "scheme #3'",
                                       "scheme #8",
                                       "scheme #9"
                                     )
        ) +
        scale_x_log10(limits = c(0.0001,1))

suppressWarnings( invisible( capture.output( 
  comps89Plot + ylim(0.75,1)
) ) )

```

*** =right

```{r, fig.height=3.5, fig.width=4., fig.align = 'center', comment = NA, message = F, echo = F, dev='svg'}

effRateComps89DF <-
                          data.frame(eff   = roc3p[["myEff"]],
                                     rate  = rate3p,
                                     model = rep("scheme #3'",nBins)
                          )
effRateComps89DF <- rbind( data.frame( eff   = roc8[["myEff"]],
                                       rate  = rate8,
                                       model = rep("scheme #8",nBins)
                          ),
                          effRateComps89DF
                    )
effRateComps89DF <- rbind( data.frame( eff   = roc9[["myEff"]],
                                       rate  = rate9,
                                       model = rep("scheme #9",nBins)
                           ),
                           effRateComps89DF
                    )

effRateComps89Plot <- ggplot(effRateComps89DF, aes(x = rate, y = eff, group = model, colour = model) ) +
               geom_point(shape=1,size=0.1) + 
               geom_line() + 
               theme(
                    title = element_text(size=15),
                    axis.title.x = element_text(size=15),
                    axis.text.x  = element_text(size=15),
                    legend.position = c(.20, .78),
                    legend.background = element_rect(fill = 'grey92', colour = 'black', size=0),
                    legend.text = element_text(size=rel(1.2)),
                    legend.title = element_blank() #element_text(size=rel(0.8), face="bold", hjust=0)
               ) +
               labs(y = "efficiency",
                    x = "total rate",
                    title = "Efficiency-rate curves"
               ) +
               scale_colour_manual(values = c(
                                              "scheme #3'" = "#CD9600",
                                              "scheme #8"  = "#00BE67",
                                              "scheme #9"  = "#00A9FF"
                                            ),
                                   breaks = c(
                                              "scheme #3'",
                                              "scheme #8",
                                              "scheme #9"
                                            ),
                                   labels = c(
                                              "scheme #3'",
                                              "scheme #8",
                                              "scheme #9"
                                            )
               ) +
               scale_x_log10(limits = c(30,30000))

suppressWarnings( invisible( capture.output(
  effRateComps89Plot + ylim(0.75, 1)
) ) )

```

*** =fullwidth

Trade-off: getting better at higer pT (bottom-left) means loosing at low pT (top-right)


--- .class #id

## Summary

The best compression scheme appears to be scheme #7 (compatible with 
[Andrew's proposal](https://indico.cern.ch/event/623713/contributions/2516606/subcontributions/222725/attachments/1429297/2194604/2017_03_09_EMTF_LUT_bit_assignment.pdf)):

type| $\theta$ | $\Delta\phi_{12}$ | $\Delta\phi_{23}$ | $\Delta\phi_{34}$ | $S^\phi_{12,23}$ | $S^\phi_{12,34}$ | $\Delta\theta_{14}$ | clct | fr
----|----------|-------------------|-------------------|-------------------|------------------|------------------|---------------------|------|-----
#7  |  [7:2]   |     [9:2]         |      [7:2]        |       [7:2]       |         1        |        1         |       [2:0]         | 2,0,0,0 | 1,0,0,0

* all other $\Delta\theta$ are dropped
* predictors are unsigned and saturated (i.e. stuck to the largest allowed value if above)
* $ring1$ and $\theta$ are combined according to Andrew's proposal

I didn't show most of the performance plots, but I can assure you that $fr1$ is important

Now I'll move on modes other then #15 and include RPCs
